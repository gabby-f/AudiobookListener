{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.MpcSv7Parser = void 0;\nconst debug_1 = require(\"debug\");\nconst BasicParser_1 = require(\"../../common/BasicParser\");\nconst APEv2Parser_1 = require(\"../../apev2/APEv2Parser\");\nconst BitReader_1 = require(\"./BitReader\");\nconst SV7 = require(\"./StreamVersion7\");\nconst debug = (0, debug_1.default)('music-metadata:parser:musepack');\nclass MpcSv7Parser extends BasicParser_1.BasicParser {\n  constructor() {\n    super(...arguments);\n    this.audioLength = 0;\n  }\n  async parse() {\n    const header = await this.tokenizer.readToken(SV7.Header);\n    if (header.signature !== 'MP+') throw new Error('Unexpected magic number');\n    debug(`stream-version=${header.streamMajorVersion}.${header.streamMinorVersion}`);\n    this.metadata.setFormat('container', 'Musepack, SV7');\n    this.metadata.setFormat('sampleRate', header.sampleFrequency);\n    const numberOfSamples = 1152 * (header.frameCount - 1) + header.lastFrameLength;\n    this.metadata.setFormat('numberOfSamples', numberOfSamples);\n    this.duration = numberOfSamples / header.sampleFrequency;\n    this.metadata.setFormat('duration', this.duration);\n    this.bitreader = new BitReader_1.BitReader(this.tokenizer);\n    this.metadata.setFormat('numberOfChannels', header.midSideStereo || header.intensityStereo ? 2 : 1);\n    const version = await this.bitreader.read(8);\n    this.metadata.setFormat('codec', (version / 100).toFixed(2));\n    await this.skipAudioData(header.frameCount);\n    debug(`End of audio stream, switching to APEv2, offset=${this.tokenizer.position}`);\n    return APEv2Parser_1.APEv2Parser.tryParseApeHeader(this.metadata, this.tokenizer, this.options);\n  }\n  async skipAudioData(frameCount) {\n    while (frameCount-- > 0) {\n      const frameLength = await this.bitreader.read(20);\n      this.audioLength += 20 + frameLength;\n      await this.bitreader.ignore(frameLength);\n    }\n    // last frame\n    const lastFrameLength = await this.bitreader.read(11);\n    this.audioLength += lastFrameLength;\n    this.metadata.setFormat('bitrate', this.audioLength / this.duration);\n  }\n}\nexports.MpcSv7Parser = MpcSv7Parser;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}