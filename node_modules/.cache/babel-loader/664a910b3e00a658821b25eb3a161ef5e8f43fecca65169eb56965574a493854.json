{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.StreamReader = void 0;\nconst Token = require(\"token-types\");\nconst debug_1 = require(\"debug\");\nconst util = require(\"../../common/Util\");\nconst debug = (0, debug_1.default)('music-metadata:parser:musepack:sv8');\nconst PacketKey = new Token.StringType(2, 'binary');\n/**\n * Stream Header Packet part 1\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\n */\nconst SH_part1 = {\n  len: 5,\n  get: (buf, off) => {\n    return {\n      crc: Token.UINT32_LE.get(buf, off),\n      streamVersion: Token.UINT8.get(buf, off + 4)\n    };\n  }\n};\n/**\n * Stream Header Packet part 3\n * Ref: http://trac.musepack.net/musepack/wiki/SV8Specification#StreamHeaderPacket\n */\nconst SH_part3 = {\n  len: 2,\n  get: (buf, off) => {\n    return {\n      sampleFrequency: [44100, 48000, 37800, 32000][util.getBitAllignedNumber(buf, off, 0, 3)],\n      maxUsedBands: util.getBitAllignedNumber(buf, off, 3, 5),\n      channelCount: util.getBitAllignedNumber(buf, off + 1, 0, 4) + 1,\n      msUsed: util.isBitSet(buf, off + 1, 4),\n      audioBlockFrames: util.getBitAllignedNumber(buf, off + 1, 5, 3)\n    };\n  }\n};\nclass StreamReader {\n  constructor(tokenizer) {\n    this.tokenizer = tokenizer;\n  }\n  async readPacketHeader() {\n    const key = await this.tokenizer.readToken(PacketKey);\n    const size = await this.readVariableSizeField();\n    return {\n      key,\n      payloadLength: size.value - 2 - size.len\n    };\n  }\n  async readStreamHeader(size) {\n    const streamHeader = {};\n    debug(`Reading SH at offset=${this.tokenizer.position}`);\n    const part1 = await this.tokenizer.readToken(SH_part1);\n    size -= SH_part1.len;\n    Object.assign(streamHeader, part1);\n    debug(`SH.streamVersion = ${part1.streamVersion}`);\n    const sampleCount = await this.readVariableSizeField();\n    size -= sampleCount.len;\n    streamHeader.sampleCount = sampleCount.value;\n    const bs = await this.readVariableSizeField();\n    size -= bs.len;\n    streamHeader.beginningOfSilence = bs.value;\n    const part3 = await this.tokenizer.readToken(SH_part3);\n    size -= SH_part3.len;\n    Object.assign(streamHeader, part3);\n    // assert.equal(size, 0);\n    await this.tokenizer.ignore(size);\n    return streamHeader;\n  }\n  async readVariableSizeField(len = 1, hb = 0) {\n    let n = await this.tokenizer.readNumber(Token.UINT8);\n    if ((n & 0x80) === 0) {\n      return {\n        len,\n        value: hb + n\n      };\n    }\n    n &= 0x7F;\n    n += hb;\n    return this.readVariableSizeField(len + 1, n << 7);\n  }\n}\nexports.StreamReader = StreamReader;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}