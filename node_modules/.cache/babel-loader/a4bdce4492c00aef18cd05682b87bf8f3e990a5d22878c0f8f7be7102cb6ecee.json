{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Atom = void 0;\nconst debug_1 = require(\"debug\");\nconst AtomToken = require(\"./AtomToken\");\nconst debug = (0, debug_1.default)('music-metadata:parser:MP4:Atom');\nclass Atom {\n  static async readAtom(tokenizer, dataHandler, parent, remaining) {\n    // Parse atom header\n    const offset = tokenizer.position;\n    // debug(`Reading next token on offset=${offset}...`); //  buf.toString('ascii')\n    const header = await tokenizer.readToken(AtomToken.Header);\n    const extended = header.length === BigInt(1);\n    if (extended) {\n      header.length = await tokenizer.readToken(AtomToken.ExtendedSize);\n    }\n    const atomBean = new Atom(header, header.length === BigInt(1), parent);\n    const payloadLength = atomBean.getPayloadLength(remaining);\n    debug(`parse atom name=${atomBean.atomPath}, extended=${atomBean.extended}, offset=${offset}, len=${atomBean.header.length}`); //  buf.toString('ascii')\n    await atomBean.readData(tokenizer, dataHandler, payloadLength);\n    return atomBean;\n  }\n  constructor(header, extended, parent) {\n    this.header = header;\n    this.extended = extended;\n    this.parent = parent;\n    this.children = [];\n    this.atomPath = (this.parent ? this.parent.atomPath + '.' : '') + this.header.name;\n  }\n  getHeaderLength() {\n    return this.extended ? 16 : 8;\n  }\n  getPayloadLength(remaining) {\n    return (this.header.length === BigInt(0) ? remaining : Number(this.header.length)) - this.getHeaderLength();\n  }\n  async readAtoms(tokenizer, dataHandler, size) {\n    while (size > 0) {\n      const atomBean = await Atom.readAtom(tokenizer, dataHandler, this, size);\n      this.children.push(atomBean);\n      size -= atomBean.header.length === BigInt(0) ? size : Number(atomBean.header.length);\n    }\n  }\n  async readData(tokenizer, dataHandler, remaining) {\n    switch (this.header.name) {\n      // \"Container\" atoms, contains nested atoms\n      case 'moov': // The Movie Atom: contains other atoms\n      case 'udta': // User defined atom\n      case 'trak':\n      case 'mdia': // Media atom\n      case 'minf': // Media Information Atom\n      case 'stbl': // The Sample Table Atom\n      case '<id>':\n      case 'ilst':\n      case 'tref':\n        return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining));\n      case 'meta':\n        // Metadata Atom, ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW8\n        // meta has 4 bytes of padding, ignore\n        const peekHeader = await tokenizer.peekToken(AtomToken.Header);\n        const paddingLength = peekHeader.name === 'hdlr' ? 0 : 4;\n        await tokenizer.ignore(paddingLength);\n        return this.readAtoms(tokenizer, dataHandler, this.getPayloadLength(remaining) - paddingLength);\n      case 'mdhd': // Media header atom\n      case 'mvhd': // 'movie' => 'mvhd': movie header atom; child of Movie Atom\n      case 'tkhd':\n      case 'stsz':\n      case 'mdat':\n      default:\n        return dataHandler(this, remaining);\n    }\n  }\n}\nexports.Atom = Atom;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}