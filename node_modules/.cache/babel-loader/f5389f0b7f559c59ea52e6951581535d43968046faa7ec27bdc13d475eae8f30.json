{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ChapterText = exports.StcoAtom = exports.StszAtom = exports.StscAtom = exports.SampleToChunkToken = exports.SttsAtom = exports.TimeToSampleToken = exports.SoundSampleDescriptionV0 = exports.SoundSampleDescriptionVersion = exports.StsdAtom = exports.TrackHeaderAtom = exports.NameAtom = exports.DataAtom = exports.MvhdAtom = exports.MdhdAtom = exports.FixedLengthAtom = exports.mhdr = exports.tkhd = exports.ftyp = exports.ExtendedSize = exports.Header = void 0;\nconst Token = require(\"token-types\");\nconst debug_1 = require(\"debug\");\nconst FourCC_1 = require(\"../common/FourCC\");\nconst debug = (0, debug_1.default)('music-metadata:parser:MP4:atom');\nexports.Header = {\n  len: 8,\n  get: (buf, off) => {\n    const length = Token.UINT32_BE.get(buf, off);\n    if (length < 0) throw new Error('Invalid atom header length');\n    return {\n      length: BigInt(length),\n      name: new Token.StringType(4, 'binary').get(buf, off + 4)\n    };\n  },\n  put: (buf, off, hdr) => {\n    Token.UINT32_BE.put(buf, off, Number(hdr.length));\n    return FourCC_1.FourCcToken.put(buf, off + 4, hdr.name);\n  }\n};\n/**\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap1/qtff1.html#//apple_ref/doc/uid/TP40000939-CH203-38190\n */\nexports.ExtendedSize = Token.UINT64_BE;\nexports.ftyp = {\n  len: 4,\n  get: (buf, off) => {\n    return {\n      type: new Token.StringType(4, 'ascii').get(buf, off)\n    };\n  }\n};\nexports.tkhd = {\n  len: 4,\n  get: (buf, off) => {\n    return {\n      type: new Token.StringType(4, 'ascii').get(buf, off)\n    };\n  }\n};\n/**\n * Token: Movie Header Atom\n */\nexports.mhdr = {\n  len: 8,\n  get: (buf, off) => {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      nextItemID: Token.UINT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\n * Base class for 'fixed' length atoms.\n * In some cases these atoms are longer then the sum of the described fields.\n * Issue: https://github.com/Borewit/music-metadata/issues/120\n */\nclass FixedLengthAtom {\n  /**\n   *\n   * @param {number} len Length as specified in the size field\n   * @param {number} expLen Total length of sum of specified fields in the standard\n   */\n  constructor(len, expLen, atomId) {\n    this.len = len;\n    if (len < expLen) {\n      throw new Error(`Atom ${atomId} expected to be ${expLen}, but specifies ${len} bytes long.`);\n    } else if (len > expLen) {\n      debug(`Warning: atom ${atomId} expected to be ${expLen}, but was actually ${len} bytes long.`);\n    }\n  }\n}\nexports.FixedLengthAtom = FixedLengthAtom;\n/**\n * Timestamp stored in seconds since Mac Epoch (1 January 1904)\n */\nconst SecondsSinceMacEpoch = {\n  len: 4,\n  get: (buf, off) => {\n    const secondsSinceUnixEpoch = Token.UINT32_BE.get(buf, off) - 2082844800;\n    return new Date(secondsSinceUnixEpoch * 1000);\n  }\n};\n/**\n * Token: Media Header Atom\n * Ref:\n * - https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-SW34\n * - https://wiki.multimedia.cx/index.php/QuickTime_container#mdhd\n */\nclass MdhdAtom extends FixedLengthAtom {\n  constructor(len) {\n    super(len, 24, 'mdhd');\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off + 0),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      timeScale: Token.UINT32_BE.get(buf, off + 12),\n      duration: Token.UINT32_BE.get(buf, off + 16),\n      language: Token.UINT16_BE.get(buf, off + 20),\n      quality: Token.UINT16_BE.get(buf, off + 22)\n    };\n  }\n}\nexports.MdhdAtom = MdhdAtom;\n/**\n * Token: Movie Header Atom\n */\nclass MvhdAtom extends FixedLengthAtom {\n  constructor(len) {\n    super(len, 100, 'mvhd');\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      timeScale: Token.UINT32_BE.get(buf, off + 12),\n      duration: Token.UINT32_BE.get(buf, off + 16),\n      preferredRate: Token.UINT32_BE.get(buf, off + 20),\n      preferredVolume: Token.UINT16_BE.get(buf, off + 24),\n      // ignore reserver: 10 bytes\n      // ignore matrix structure: 36 bytes\n      previewTime: Token.UINT32_BE.get(buf, off + 72),\n      previewDuration: Token.UINT32_BE.get(buf, off + 76),\n      posterTime: Token.UINT32_BE.get(buf, off + 80),\n      selectionTime: Token.UINT32_BE.get(buf, off + 84),\n      selectionDuration: Token.UINT32_BE.get(buf, off + 88),\n      currentTime: Token.UINT32_BE.get(buf, off + 92),\n      nextTrackID: Token.UINT32_BE.get(buf, off + 96)\n    };\n  }\n}\nexports.MvhdAtom = MvhdAtom;\n/**\n * Data Atom Structure\n */\nclass DataAtom {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      type: {\n        set: Token.UINT8.get(buf, off + 0),\n        type: Token.UINT24_BE.get(buf, off + 1)\n      },\n      locale: Token.UINT24_BE.get(buf, off + 4),\n      value: Buffer.from(new Token.Uint8ArrayType(this.len - 8).get(buf, off + 8))\n    };\n  }\n}\nexports.DataAtom = DataAtom;\n/**\n * Data Atom Structure\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/Metadata/Metadata.html#//apple_ref/doc/uid/TP40000939-CH1-SW31\n */\nclass NameAtom {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      name: new Token.StringType(this.len - 4, 'utf-8').get(buf, off + 4)\n    };\n  }\n}\nexports.NameAtom = NameAtom;\n/**\n * Track Header Atoms structure\n * Ref: https://developer.apple.com/library/content/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25550\n */\nclass TrackHeaderAtom {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      creationTime: SecondsSinceMacEpoch.get(buf, off + 4),\n      modificationTime: SecondsSinceMacEpoch.get(buf, off + 8),\n      trackId: Token.UINT32_BE.get(buf, off + 12),\n      // reserved 4 bytes\n      duration: Token.UINT32_BE.get(buf, off + 20),\n      layer: Token.UINT16_BE.get(buf, off + 24),\n      alternateGroup: Token.UINT16_BE.get(buf, off + 26),\n      volume: Token.UINT16_BE.get(buf, off + 28) // ToDo: fixed point\n      // ToDo: add remaining fields\n    };\n  }\n}\nexports.TrackHeaderAtom = TrackHeaderAtom;\n/**\n * Atom: Sample Description Atom ('stsd')\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\n */\nconst stsdHeader = {\n  len: 8,\n  get: (buf, off) => {\n    return {\n      version: Token.UINT8.get(buf, off),\n      flags: Token.UINT24_BE.get(buf, off + 1),\n      numberOfEntries: Token.UINT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\n * Atom: Sample Description Atom ('stsd')\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\n */\nclass SampleDescriptionTable {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    return {\n      dataFormat: FourCC_1.FourCcToken.get(buf, off),\n      dataReferenceIndex: Token.UINT16_BE.get(buf, off + 10),\n      description: new Token.Uint8ArrayType(this.len - 12).get(buf, off + 12)\n    };\n  }\n}\n/**\n * Atom: Sample-description Atom ('stsd')\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25691\n */\nclass StsdAtom {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    const header = stsdHeader.get(buf, off);\n    off += stsdHeader.len;\n    const table = [];\n    for (let n = 0; n < header.numberOfEntries; ++n) {\n      const size = Token.UINT32_BE.get(buf, off); // Sample description size\n      off += Token.UINT32_BE.len;\n      table.push(new SampleDescriptionTable(size).get(buf, off));\n      off += size;\n    }\n    return {\n      header,\n      table\n    };\n  }\n}\nexports.StsdAtom = StsdAtom;\n/**\n * Common Sound Sample Description (version & revision)\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-57317\n */\nexports.SoundSampleDescriptionVersion = {\n  len: 8,\n  get(buf, off) {\n    return {\n      version: Token.INT16_BE.get(buf, off),\n      revision: Token.INT16_BE.get(buf, off + 2),\n      vendor: Token.INT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\n * Sound Sample Description (Version 0)\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap3/qtff3.html#//apple_ref/doc/uid/TP40000939-CH205-130736\n */\nexports.SoundSampleDescriptionV0 = {\n  len: 12,\n  get(buf, off) {\n    return {\n      numAudioChannels: Token.INT16_BE.get(buf, off + 0),\n      sampleSize: Token.INT16_BE.get(buf, off + 2),\n      compressionId: Token.INT16_BE.get(buf, off + 4),\n      packetSize: Token.INT16_BE.get(buf, off + 6),\n      sampleRate: Token.UINT16_BE.get(buf, off + 8) + Token.UINT16_BE.get(buf, off + 10) / 10000\n    };\n  }\n};\nclass SimpleTableAtom {\n  constructor(len, token) {\n    this.len = len;\n    this.token = token;\n  }\n  get(buf, off) {\n    const nrOfEntries = Token.INT32_BE.get(buf, off + 4);\n    return {\n      version: Token.INT8.get(buf, off + 0),\n      flags: Token.INT24_BE.get(buf, off + 1),\n      numberOfEntries: nrOfEntries,\n      entries: readTokenTable(buf, this.token, off + 8, this.len - 8, nrOfEntries)\n    };\n  }\n}\nexports.TimeToSampleToken = {\n  len: 8,\n  get(buf, off) {\n    return {\n      count: Token.INT32_BE.get(buf, off + 0),\n      duration: Token.INT32_BE.get(buf, off + 4)\n    };\n  }\n};\n/**\n * Time-to-sample('stts') atom.\n * Store duration information for a mediaâ€™s samples.\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25696\n */\nclass SttsAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, exports.TimeToSampleToken);\n    this.len = len;\n  }\n}\nexports.SttsAtom = SttsAtom;\nexports.SampleToChunkToken = {\n  len: 12,\n  get(buf, off) {\n    return {\n      firstChunk: Token.INT32_BE.get(buf, off),\n      samplesPerChunk: Token.INT32_BE.get(buf, off + 4),\n      sampleDescriptionId: Token.INT32_BE.get(buf, off + 8)\n    };\n  }\n};\n/**\n * Sample-to-Chunk ('stsc') atom interface\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25706\n */\nclass StscAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, exports.SampleToChunkToken);\n    this.len = len;\n  }\n}\nexports.StscAtom = StscAtom;\n/**\n * Sample-size ('stsz') atom\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25710\n */\nclass StszAtom {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    const nrOfEntries = Token.INT32_BE.get(buf, off + 8);\n    return {\n      version: Token.INT8.get(buf, off),\n      flags: Token.INT24_BE.get(buf, off + 1),\n      sampleSize: Token.INT32_BE.get(buf, off + 4),\n      numberOfEntries: nrOfEntries,\n      entries: readTokenTable(buf, Token.INT32_BE, off + 12, this.len - 12, nrOfEntries)\n    };\n  }\n}\nexports.StszAtom = StszAtom;\n/**\n * Chunk offset atom, 'stco'\n * Ref: https://developer.apple.com/library/archive/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html#//apple_ref/doc/uid/TP40000939-CH204-25715\n */\nclass StcoAtom extends SimpleTableAtom {\n  constructor(len) {\n    super(len, Token.INT32_BE);\n    this.len = len;\n  }\n}\nexports.StcoAtom = StcoAtom;\n/**\n * Token used to decode text-track from 'mdat' atom (raw data stream)\n */\nclass ChapterText {\n  constructor(len) {\n    this.len = len;\n  }\n  get(buf, off) {\n    const titleLen = Token.INT16_BE.get(buf, off + 0);\n    const str = new Token.StringType(titleLen, 'utf-8');\n    return str.get(buf, off + 2);\n  }\n}\nexports.ChapterText = ChapterText;\nfunction readTokenTable(buf, token, off, remainingLen, numberOfEntries) {\n  debug(`remainingLen=${remainingLen}, numberOfEntries=${numberOfEntries} * token-len=${token.len}`);\n  if (remainingLen === 0) return [];\n  if (remainingLen !== numberOfEntries * token.len) throw new Error('mismatch number-of-entries with remaining atom-length');\n  const entries = [];\n  // parse offset-table\n  for (let n = 0; n < numberOfEntries; ++n) {\n    entries.push(token.get(buf, off));\n    off += token.len;\n  }\n  return entries;\n}","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}