{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.MpcSv8Parser = void 0;\nconst debug_1 = require(\"debug\");\nconst BasicParser_1 = require(\"../../common/BasicParser\");\nconst APEv2Parser_1 = require(\"../../apev2/APEv2Parser\");\nconst FourCC_1 = require(\"../../common/FourCC\");\nconst SV8 = require(\"./StreamVersion8\");\nconst debug = (0, debug_1.default)('music-metadata:parser:musepack');\nclass MpcSv8Parser extends BasicParser_1.BasicParser {\n  constructor() {\n    super(...arguments);\n    this.audioLength = 0;\n  }\n  async parse() {\n    const signature = await this.tokenizer.readToken(FourCC_1.FourCcToken);\n    if (signature !== 'MPCK') throw new Error('Invalid Magic number');\n    this.metadata.setFormat('container', 'Musepack, SV8');\n    return this.parsePacket();\n  }\n  async parsePacket() {\n    const sv8reader = new SV8.StreamReader(this.tokenizer);\n    do {\n      const header = await sv8reader.readPacketHeader();\n      debug(`packet-header key=${header.key}, payloadLength=${header.payloadLength}`);\n      switch (header.key) {\n        case 'SH':\n          // Stream Header\n          const sh = await sv8reader.readStreamHeader(header.payloadLength);\n          this.metadata.setFormat('numberOfSamples', sh.sampleCount);\n          this.metadata.setFormat('sampleRate', sh.sampleFrequency);\n          this.metadata.setFormat('duration', sh.sampleCount / sh.sampleFrequency);\n          this.metadata.setFormat('numberOfChannels', sh.channelCount);\n          break;\n        case 'AP':\n          // Audio Packet\n          this.audioLength += header.payloadLength;\n          await this.tokenizer.ignore(header.payloadLength);\n          break;\n        case 'RG': // Replaygain\n        case 'EI': // Encoder Info\n        case 'SO': // Seek Table Offset\n        case 'ST': // Seek Table\n        case 'CT':\n          // Chapter-Tag\n          await this.tokenizer.ignore(header.payloadLength);\n          break;\n        case 'SE':\n          // Stream End\n          this.metadata.setFormat('bitrate', this.audioLength * 8 / this.metadata.format.duration);\n          return APEv2Parser_1.APEv2Parser.tryParseApeHeader(this.metadata, this.tokenizer, this.options);\n        default:\n          throw new Error(`Unexpected header: ${header.key}`);\n      }\n    } while (true);\n  }\n}\nexports.MpcSv8Parser = MpcSv8Parser;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}