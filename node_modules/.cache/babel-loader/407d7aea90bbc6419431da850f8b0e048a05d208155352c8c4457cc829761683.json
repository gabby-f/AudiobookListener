{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.OpusParser = void 0;\nconst Token = require(\"token-types\");\nconst VorbisParser_1 = require(\"../vorbis/VorbisParser\");\nconst Opus = require(\"./Opus\");\n/**\n * Opus parser\n * Internet Engineering Task Force (IETF) - RFC 6716\n * Used by OggParser\n */\nclass OpusParser extends VorbisParser_1.VorbisParser {\n  constructor(metadata, options, tokenizer) {\n    super(metadata, options);\n    this.tokenizer = tokenizer;\n    this.lastPos = -1;\n  }\n  /**\n   * Parse first Opus Ogg page\n   * @param {IPageHeader} header\n   * @param {Buffer} pageData\n   */\n  parseFirstPage(header, pageData) {\n    this.metadata.setFormat('codec', 'Opus');\n    // Parse Opus ID Header\n    this.idHeader = new Opus.IdHeader(pageData.length).get(pageData, 0);\n    if (this.idHeader.magicSignature !== \"OpusHead\") throw new Error(\"Illegal ogg/Opus magic-signature\");\n    this.metadata.setFormat('sampleRate', this.idHeader.inputSampleRate);\n    this.metadata.setFormat('numberOfChannels', this.idHeader.channelCount);\n  }\n  parseFullPage(pageData) {\n    const magicSignature = new Token.StringType(8, 'ascii').get(pageData, 0);\n    switch (magicSignature) {\n      case 'OpusTags':\n        this.parseUserCommentList(pageData, 8);\n        this.lastPos = this.tokenizer.position - pageData.length;\n        break;\n      default:\n        break;\n    }\n  }\n  calculateDuration(header) {\n    if (this.metadata.format.sampleRate && header.absoluteGranulePosition >= 0) {\n      // Calculate duration\n      const pos_48bit = header.absoluteGranulePosition - this.idHeader.preSkip;\n      this.metadata.setFormat('numberOfSamples', pos_48bit);\n      this.metadata.setFormat('duration', pos_48bit / 48000);\n      if (this.lastPos !== -1 && this.tokenizer.fileInfo.size && this.metadata.format.duration) {\n        const dataSize = this.tokenizer.fileInfo.size - this.lastPos;\n        this.metadata.setFormat('bitrate', 8 * dataSize / this.metadata.format.duration);\n      }\n    }\n  }\n}\nexports.OpusParser = OpusParser;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}