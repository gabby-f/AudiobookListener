{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.AsfParser = void 0;\nconst debug_1 = require(\"debug\");\nconst type_1 = require(\"../type\");\nconst GUID_1 = require(\"./GUID\");\nconst AsfObject = require(\"./AsfObject\");\nconst BasicParser_1 = require(\"../common/BasicParser\");\nconst debug = (0, debug_1.default)('music-metadata:parser:ASF');\nconst headerType = 'asf';\n/**\n * Windows Media Metadata Usage Guidelines\n * - Ref: https://msdn.microsoft.com/en-us/library/ms867702.aspx\n *\n * Ref:\n * - https://tools.ietf.org/html/draft-fleischman-asf-01\n * - https://hwiegman.home.xs4all.nl/fileformats/asf/ASF_Specification.pdf\n * - http://drang.s4.xrea.com/program/tips/id3tag/wmp/index.html\n * - https://msdn.microsoft.com/en-us/library/windows/desktop/ee663575(v=vs.85).aspx\n */\nclass AsfParser extends BasicParser_1.BasicParser {\n  async parse() {\n    const header = await this.tokenizer.readToken(AsfObject.TopLevelHeaderObjectToken);\n    if (!header.objectId.equals(GUID_1.default.HeaderObject)) {\n      throw new Error('expected asf header; but was not found; got: ' + header.objectId.str);\n    }\n    try {\n      await this.parseObjectHeader(header.numberOfHeaderObjects);\n    } catch (err) {\n      debug('Error while parsing ASF: %s', err);\n    }\n  }\n  async parseObjectHeader(numberOfObjectHeaders) {\n    let tags;\n    do {\n      // Parse common header of the ASF Object (3.1)\n      const header = await this.tokenizer.readToken(AsfObject.HeaderObjectToken);\n      // Parse data part of the ASF Object\n      debug('header GUID=%s', header.objectId.str);\n      switch (header.objectId.str) {\n        case AsfObject.FilePropertiesObject.guid.str:\n          // 3.2\n          const fpo = await this.tokenizer.readToken(new AsfObject.FilePropertiesObject(header));\n          this.metadata.setFormat('duration', Number(fpo.playDuration / BigInt(1000)) / 10000 - Number(fpo.preroll) / 1000);\n          this.metadata.setFormat('bitrate', fpo.maximumBitrate);\n          break;\n        case AsfObject.StreamPropertiesObject.guid.str:\n          // 3.3\n          const spo = await this.tokenizer.readToken(new AsfObject.StreamPropertiesObject(header));\n          this.metadata.setFormat('container', 'ASF/' + spo.streamType);\n          break;\n        case AsfObject.HeaderExtensionObject.guid.str:\n          // 3.4\n          const extHeader = await this.tokenizer.readToken(new AsfObject.HeaderExtensionObject());\n          await this.parseExtensionObject(extHeader.extensionDataSize);\n          break;\n        case AsfObject.ContentDescriptionObjectState.guid.str:\n          // 3.10\n          tags = await this.tokenizer.readToken(new AsfObject.ContentDescriptionObjectState(header));\n          this.addTags(tags);\n          break;\n        case AsfObject.ExtendedContentDescriptionObjectState.guid.str:\n          // 3.11\n          tags = await this.tokenizer.readToken(new AsfObject.ExtendedContentDescriptionObjectState(header));\n          this.addTags(tags);\n          break;\n        case GUID_1.default.CodecListObject.str:\n          const codecs = await AsfObject.readCodecEntries(this.tokenizer);\n          codecs.forEach(codec => {\n            this.metadata.addStreamInfo({\n              type: codec.type.videoCodec ? type_1.TrackType.video : type_1.TrackType.audio,\n              codecName: codec.codecName\n            });\n          });\n          const audioCodecs = codecs.filter(codec => codec.type.audioCodec).map(codec => codec.codecName).join('/');\n          this.metadata.setFormat('codec', audioCodecs);\n          break;\n        case GUID_1.default.StreamBitratePropertiesObject.str:\n          // ToDo?\n          await this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len);\n          break;\n        case GUID_1.default.PaddingObject.str:\n          // ToDo: register bytes pad\n          debug('Padding: %s bytes', header.objectSize - AsfObject.HeaderObjectToken.len);\n          await this.tokenizer.ignore(header.objectSize - AsfObject.HeaderObjectToken.len);\n          break;\n        default:\n          this.metadata.addWarning('Ignore ASF-Object-GUID: ' + header.objectId.str);\n          debug('Ignore ASF-Object-GUID: %s', header.objectId.str);\n          await this.tokenizer.readToken(new AsfObject.IgnoreObjectState(header));\n      }\n    } while (--numberOfObjectHeaders);\n    // done\n  }\n  addTags(tags) {\n    tags.forEach(tag => {\n      this.metadata.addTag(headerType, tag.id, tag.value);\n    });\n  }\n  async parseExtensionObject(extensionSize) {\n    do {\n      // Parse common header of the ASF Object (3.1)\n      const header = await this.tokenizer.readToken(AsfObject.HeaderObjectToken);\n      const remaining = header.objectSize - AsfObject.HeaderObjectToken.len;\n      // Parse data part of the ASF Object\n      switch (header.objectId.str) {\n        case AsfObject.ExtendedStreamPropertiesObjectState.guid.str:\n          // 4.1\n          // ToDo: extended stream header properties are ignored\n          await this.tokenizer.readToken(new AsfObject.ExtendedStreamPropertiesObjectState(header));\n          break;\n        case AsfObject.MetadataObjectState.guid.str:\n          // 4.7\n          const moTags = await this.tokenizer.readToken(new AsfObject.MetadataObjectState(header));\n          this.addTags(moTags);\n          break;\n        case AsfObject.MetadataLibraryObjectState.guid.str:\n          // 4.8\n          const mlTags = await this.tokenizer.readToken(new AsfObject.MetadataLibraryObjectState(header));\n          this.addTags(mlTags);\n          break;\n        case GUID_1.default.PaddingObject.str:\n          // ToDo: register bytes pad\n          await this.tokenizer.ignore(remaining);\n          break;\n        case GUID_1.default.CompatibilityObject.str:\n          this.tokenizer.ignore(remaining);\n          break;\n        case GUID_1.default.ASF_Index_Placeholder_Object.str:\n          await this.tokenizer.ignore(remaining);\n          break;\n        default:\n          this.metadata.addWarning('Ignore ASF-Object-GUID: ' + header.objectId.str);\n          // console.log(\"Ignore ASF-Object-GUID: %s\", header.objectId.str);\n          await this.tokenizer.readToken(new AsfObject.IgnoreObjectState(header));\n          break;\n      }\n      extensionSize -= header.objectSize;\n    } while (extensionSize > 0);\n  }\n}\nexports.AsfParser = AsfParser;","map":null,"metadata":{},"sourceType":"script","externalDependencies":[]}